name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - run: go build ./cmd/gh-pulse

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - uses: golangci/golangci-lint-action@v4
        with:
          version: latest

  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - run: go build ./cmd/gh-pulse
      - name: Integration test with smee.io
        run: |
          SMEE_URL="https://smee.io/gh-pulse-ci-${{ github.run_id }}"

          timeout 30 ./gh-pulse stream --url "$SMEE_URL" --success-on "event=ping" --timeout 25 > output.jsonl 2>status.log &
          PID=$!
          sleep 3

          curl -X POST "$SMEE_URL" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: ping" \
            -H "X-GitHub-Delivery: ci-test-${{ github.run_id }}" \
            -d '{"zen":"test"}'

          wait $PID
          EXIT_CODE=$?

          echo "Exit code: $EXIT_CODE"
          cat output.jsonl

          test $EXIT_CODE -eq 0
          grep -q '"event":"ping"' output.jsonl
